function declOfNum(b, c) {
    var a = [2, 0, 1, 1, 1, 2];
    return c[(b % 100 > 4 && b % 100 < 20) ? 2 : a[(b % 10 < 5) ? b % 10 : 5]]
}

var calculateResult = {
    city: "Алматы",
    phone: "",
    name: "",
    email: "",
    room_count: 1,
    bathroom_count: 1,
    cleaning_type: "Стандарт",
    object_type: "Квартира",
    object_type_index: "flat",
    additional_services: {},
    additional_services_check: {},
    drycleaning: {},
    cleaning_count: "Один раз",
    stock: 0,
    date: "",
    time: "",
    street: "",
    house: "",
    stage: "",
    flat: "",
    comment: "",
    payment_type: "Оплата наличными",
    total_amount: 0,
    coupon: 0,
    coupon_amount: 0
};
var dateToday = new Date();
var dateInput = $('#calculator-pop-up .additional-options input[name="date"]');
var templateSelect = $('#calculator-pop-up .user-templates select[name="template"]');
var couponSelect = $('#calculator-pop-up .coupons-block select[name="coupon"]');
var timeSelect = $('#calculator-pop-up .additional-options select[name="time"]');
var cleaningCountSelect = $('#calculator-pop-up select[name="cleaning-count-mobile"]');
var citySelect = $('#calculator-pop-up select[name="city"]');
if (window.outerWidth > 768) {
    dateInput.datepicker({
        minDate: dateToday,
        showOtherMonths: true,
        parentDiv: dateInput.parent("div"),
        onSelect: function () {
            calculateUpdateResult()
        }
    });
    templateSelect.selectmenu({
        appendTo: templateSelect.parent(), change: function (a, b) {
            calculateSetTemplate()
        }
    });
    couponSelect.selectmenu({
        appendTo: couponSelect.parent(), change: function (a, b) {
            calculateSetCoupon()
        }
    });
    timeSelect.selectmenu({
        appendTo: timeSelect.parent(), change: function (a, b) {
            calculateResult.time = b.item.value;
            calculateUpdateResult()
        }
    });
    citySelect.selectmenu({
        appendTo: citySelect.parent(), change: function (a, b) {
            calculateResult.city = b.item.value
        }
    })
} else {
    var nowDateYear = new Date().getFullYear(), nowDateMonth = (new Date().getMonth() + 1),
        nowDateDay = new Date().getDate();
    var nowDate = nowDateYear + "-";
    nowDate += nowDateMonth < 10 ? "0" : "";
    nowDate += nowDateMonth + "-";
    nowDate += nowDateDay < 10 ? "0" : "";
    nowDate += nowDateDay;
    dateInput.attr({type: "date", value: nowDate}).change(calculateUpdateResult);
    cleaningCountSelect.change(calculateUpdateResult);
    timeSelect.change(function () {
        calculateResult.time = $(this).val();
        calculateUpdateResult()
    });
    citySelect.change(function () {
        calculateResult.city = $(this).val()
    });
    templateSelect.change(function () {
        calculateSetTemplate()
    });
    couponSelect.change(function () {
        calculateSetTemplate()
    })
}
$('input[name="phone"]').inputmask("(999) 999-9999", {placeholder: "_"});
var calculateInputs = $("#calculator-pop-up .calculate-input.with-controllers input, .calculate-block .calculate-input.with-controllers input");
var customInputs = {
    "cic-room": {min: 1, prefix: [], postfix: ["-комнатная", "-комнатная", "-комнатная"]},
    "cic-bathroom": {min: 1, prefix: [], postfix: [" санузел", " санузла", " санузлов"]}
};
calculateInputs.on("keydown", function (d) {
    d = d.key;
    var b = $(this);
    var a = b.closest(".calculate-input");
    if (d.search(/Backspace/i) === -1) {
        if (b.val() > 10) {
            return false
        } else {
            if (d.search(/\d/) === -1) {
                if (a.hasClass("calculate-input-custom")) {
                    var c = customInputs[a.data("custom-index")];
                    calculateInput(b, c.min, c.prefix, c.postfix)
                } else {
                    calculateInput(b, 0, [], [])
                }
                return false
            }
            if (b.val() == 0 && d.search(/\d/) === 0) {
                b.val(d);
                if (a.hasClass("calculate-input-custom")) {
                    var c = customInputs[a.data("custom-index")];
                    calculateInput(b, c.min, c.prefix, c.postfix)
                } else {
                    calculateInput(b, 0, [], [])
                }
                return false
            }
        }
    }
});
calculateInputs.on("change blur focusout", function () {
    var b = $(this);
    var a = b.closest(".calculate-input");
    if (a.hasClass("calculate-input-custom")) {
        var c = customInputs[a.data("custom-index")];
        calculateInput(b, c.min, c.prefix, c.postfix)
    } else {
        calculateInput(b, 0, [], [])
    }
});
calculateInputs.focus(function () {
    $(this).val(parseInt($(this).val()))
});
var preloader = $("#preloader");

function prelodaerHide() {
    preloader.removeClass("show")
}

function prelodaerShow() {
    preloader.addClass("show")
}

function calculateInput(c, g, d, i) {
    var b = c.closest(".item");
    var e = c.closest(".calculate-input");
    var a;
    var h = parseInt(c.val());
    if (h < g) {
        h = g
    }
    if (c.val() === "") {
        h = g
    }
    if (d.length < 1) {
        a = h
    } else {
        a = declOfNum(h, d) + h
    }
    if (i.length > 1) {
        a = a + declOfNum(h, i)
    }
    if (h === 0) {
        b.removeClass("active");
        e.removeClass("active")
    } else {
        b.addClass("active");
        e.addClass("active")
    }
    c.val(a);
    c.trigger("input");
    if (c.data("for") !== undefined) {
        var f = $(c.data("for"));
        f.val(a);
        f.trigger("input")
    }
    calculateUpdateResult()
}

$(".calculate-input .plus, .calculate-input .minus").on("click", function () {
    var a = $(this).closest(".calculate-input");
    var b = a.find("input");
    var e = parseInt(b.val());
    var d = 0;
    var c = [];
    if (a.hasClass("calculate-input-custom")) {
        c = customInputs[a.data("custom-index")];
        d = c.min
    }
    if ($(this).hasClass("minus")) {
        e--
    } else {
        e++
    }
    if (e > 99 || e < d) {
        return false
    }
    b.val(e);
    if (c.length < 1) {
        calculateInput(b, d, [], [])
    } else {
        calculateInput(b, d, c.prefix, c.postfix)
    }
});
$('#calculator-pop-up input[type="checkbox"]').on("change", calculateUpdateResult);
$("#calculator-pop-up .middle-content .tab").on("click", function () {
    $("#calculator-pop-up .middle-content .text").removeClass("show");
    $("#calculator-pop-up .middle-content .text." + $(this).data("for")).addClass("show");
    $("#calculator-pop-up .middle-content .tab").removeClass("active");
    $(this).addClass("active");
    calculateUpdateResult()
});

function calculateUpdateResult() {
    calculateResult.total_amount = 0;
    calculateResult.additional_services = {};
    calculateResult.additional_services_check = {};
    calculateResult.drycleaning = {};
    calculateResult.room_count = parseInt($('#calculator-pop-up input[name="room_count"]').val());
    calculateResult.bathroom_count = parseInt($('#calculator-pop-up input[name="bathroom_count"]').val());
    var a = $("#calculator-pop-up .middle-content .tabs .tab.active");
    calculateResult.cleaning_type = a.data("name");
    calculateResult.total_amount = parseInt(a.data(calculateResult.object_type_index + "-price"));
    if (calculateResult.room_count > 1) {
        var d = parseInt(a.data(calculateResult.object_type_index + "-room-price"));
        d = d * (calculateResult.room_count - 1);
        calculateResult.total_amount += d
    }
    if (calculateResult.bathroom_count > 1) {
        var d = parseInt(a.data(calculateResult.object_type_index + "-bathroom-price"));
        d = d * (calculateResult.bathroom_count - 1);
        calculateResult.total_amount += d
    }
    calculateResult.date = dateInput.val();
    if (window.outerWidth < 768) {
        var b = calculateResult.date.split("-");
        calculateResult.date = b[2] + "." + b[1] + "." + b[0]
    }
    $("#calculator-pop-up .additional-services .calculate-input.active input").each(function (i, j) {
        var h = $(j);
        var l = parseInt(h.val());
        var k = parseInt(h.data("price"));
        var i = h.data("id") + "";
        var m = {count: l, name: h.data("name"), ac_id: h.data("ac-id"), ac_id_group: h.data("ac-id-group")};
        calculateResult.additional_services[i] = m;
        calculateResult.total_amount += (l * k)
    });
    $("#calculator-pop-up .additional-services-checkbox input:checked").each(function (i, j) {
        var h = $(j);
        var k = parseInt(h.data("price"));
        var i = h.data("id") + "";
        var l = {count: 1, name: h.data("name"), ac_id: h.data("ac-id"), ac_id_group: h.data("ac-id-group")};
        calculateResult.additional_services_check[i] = l;
        calculateResult.total_amount += k
    });
    if ($('#calculator-pop-up input[name="need-drycleaning"]').prop("checked")) {
        $("#calculator-pop-up .drycleaning .calculate-input.active input").each(function (i, j) {
            var h = $(j);
            var l = parseInt(h.val());
            var k = parseInt(h.data("price"));
            var i = h.data("id") + "";
            var m = {count: l, name: h.data("name"), ac_id: h.data("ac-id"), ac_id_group: h.data("ac-id-group")};
            calculateResult.drycleaning[i] = m;
            calculateResult.total_amount += (l * k)
        })
    }
    if (window.outerWidth < 768) {
        var g = cleaningCountSelect.val();
        var e = g.split("|");
        calculateResult.cleaning_count = e[0];
        calculateResult.stock = e[1]
    } else {
        var c = $("#calculator-pop-up .custom-range-labels.calculate-values li.active");
        calculateResult.cleaning_count = c.data("name");
        calculateResult.stock = parseInt(c.data("percent"))
    }
    calculateResult.payment_type = $('#calculator-pop-up input[name="payment"]:checked').val();
    calculateResult.name = $('#calculator-pop-up input[name="name"]').val();
    calculateResult.email = $('#calculator-pop-up input[name="email"]').val();
    calculateResult.phone = $('#calculator-pop-up input[name="phone"]').val();
    calculateResult.street = $('#calculator-pop-up input[name="street"]').val();
    calculateResult.house = $('#calculator-pop-up input[name="house"]').val();
    calculateResult.room = $('#calculator-pop-up input[name="room"]').val();
    calculateResult.stage = $('#calculator-pop-up input[name="stage"]').val();
    calculateResult.comment = $('#calculator-pop-up textarea[name="comment"]').val();
    if (calculateResult.stock != 0) {
        var f = calculateResult.total_amount / 100 * calculateResult.stock;
        calculateResult.total_amount -= f;
        $("#calculate-text-amount").show()
    } else {
        $("#calculate-text-amount").hide()
    }
    calculateResult.total_amount -= calculateResult.coupon_amount;
    calculateShowResult()
}

function calculateShowResult() {
    $("#calculate-cleaning-type").html(calculateResult.cleaning_type);
    var b = calculateResult.cleaning_count;
    b += calculateResult.date !== "" ? ", " + calculateResult.date : "";
    b += calculateResult.time !== "" ? ", " + calculateResult.time : "";
    $("#calculate-cleaning-options").html(b);
    var c = "";
    $.each(calculateResult.additional_services, function (d, e) {
        if (c != "") {
            c = c + ", "
        }
        c = c + e.name;
        c = c + " (" + e.count + ")"
    });
    $.each(calculateResult.additional_services_check, function (d, e) {
        if (c != "") {
            c = c + ", "
        }
        c = c + e.name
    });
    $.each(calculateResult.drycleaning, function (d, e) {
        if (c != "") {
            c = c + ", "
        }
        c = c + e.name;
        c = c + " (" + e.count + ")"
    });
    if (c != "") {
        $("#calculate-cleaning-services").html(c)
    } else {
        $("#calculate-cleaning-services").html("—")
    }
    $("#calculate-total-amount span").html(calculateResult.total_amount);
    var a = "Уборка ";
    a += calculateResult.object_type_index == "flat" ? "квартиры" : "дома";
    a += " с " + calculateResult.room_count + declOfNum(calculateResult.room_count, [" комнатой", " комнатами", " комнатами"]);
    a += " и " + calculateResult.bathroom_count + declOfNum(calculateResult.bathroom_count, [" санузлом", " санузлами", " санузлом"]);
    $("#calculator .calculate-result .title").html(a);
    $("#calculator .calculate-result .time").html(calculateResult.time === "" ? "В любое удобное время" : calculateResult.time);
    $("#calculator .calculate-result .price span").html(calculateResult.total_amount)
}

calculateUpdateResult();
$(".calculate-switch > div").on("click", function () {
    var b = $('.calculate-switch .item[data-object-type-index="' + calculateResult.object_type_index + '"]');
    var a = $('.calculate-switch .item:not([data-object-type-index="' + calculateResult.object_type_index + '"])');
    b.removeClass("active");
    a.addClass("active");
    $(".calculate-switch .line-point").removeClass(b.data("object-type-index")).addClass(a.data("object-type-index"));
    calculateResult.object_type = a.data("object-type");
    calculateResult.object_type_index = a.data("object-type-index");
    calculateUpdateResult()
});

function calculateGetDataShort() {
    var a = $('#calculator input[name="phone"]');
    calculateResult.phone = a.val().trim();
    if (calculateResult.phone === "") {
        a.closest(".calculate-input").addClass("error");
        return false
    }
    calculateSendOrder();
    return true
}

function calculateGetData() {
    var g = $('#calculator-pop-up input[name="phone"]');
    calculateResult.phone = g.val().trim();
    var c = $('#calculator-pop-up input[name="name"]');
    calculateResult.name = c.val().trim();
    var h = $('#calculator-pop-up input[name="email"]');
    calculateResult.email = h.val();
    var d = $('#calculator-pop-up input[name="street"]');
    calculateResult.street = d.val().trim();
    var a = $('#calculator-pop-up input[name="house"]');
    calculateResult.house = a.val().trim();
    var b = $('#calculator-pop-up input[name="flat"]');
    calculateResult.flat = b.val().trim();
    var f = $('#calculator-pop-up input[name="stage"]');
    calculateResult.stage = f.val();
    var e = $('#calculator-pop-up textarea[name="comment"]');
    calculateResult.comment = e.val();
    var i = $('#calculator-pop-up input[name="payment"]:checked');
    calculateResult.payment_type = i.val();
    if (calculateResult.phone === "") {
        $("#calculator-pop-up .error-message").addClass("show").html("Пожалуйста, укажите Ваш номер телефона!");
        return false
    }
    if (calculateResult.name === "") {
        $("#calculator-pop-up .error-message").addClass("show").html("Пожалуйста, укажите Ваше имя!");
        return false
    }
    if (calculateResult.street === "") {
        $("#calculator-pop-up .error-message").addClass("show").html("Пожалуйста, укажите улицу!");
        return false
    }
    if (calculateResult.house === "") {
        $("#calculator-pop-up .error-message").addClass("show").html("Пожалуйста, укажите номер дома!");
        return false
    }
    if (calculateResult.flat === "" && calculateResult.object_type_index === "flat") {
        $("#calculator-pop-up .error-message").addClass("show").html("Пожалуйста, укажите квартиру!");
        return false
    }
    calculateSendOrder()
}

function calculateSendOrder() {
    var b = $("#calculator-pop-up .error-message");
    var a = $("#calculator-pop-up").data("order-id");
    prelodaerShow();
    $.ajax({
        type: "POST",
        url: "/calculate-order-send",
        headers: {"X-CSRF-TOKEN": $('meta[name="csrf-token"]').attr("content")},
        data: {data: JSON.stringify(calculateResult), order: a},
        success: function (c) {
            try {
                c = JSON.parse(c);
                if (c.status === "success") {
                    location.href = c.redirect === "thanks" ? "/thanks?id=" + c.id + "&referer=" + location.href : c.redirect
                } else {
                    b.addClass("show").html("Произошла ошибка. Пожалуйста, попробуйте позже!")
                }
            } catch (d) {
                b.addClass("show").html("Произошла ошибка. Пожалуйста, попробуйте позже!")
            }
        },
        error: function (c) {
            console.log(c);
            b.html("Произошла ошибка. Пожалуйста, попробуйте позже!")
        },
        complete: function () {
            prelodaerHide()
        }
    })
}

function calculatePopupHide(a) {
    $("html").css("overflow", "auto");
    $("#calculator-pop-up").removeClass("show");
    if (a !== undefined) {
        if (a.data("additional-trigger") !== "") {
            window[a.data("additional-trigger")].call()
        }
    }
}

function calculatePopupShow() {
    $("#calculator-pop-up").addClass("show");
    $("html").css("overflow", "hidden");
    crsetMargin()
}

$("#calculator-pop-up .drycleaning .custom-checkbox input").change(function () {
    if ($(this).prop("checked")) {
        $("#calculator-pop-up .drycleaning").addClass("show")
    } else {
        $("#calculator-pop-up .drycleaning").removeClass("show")
    }
});

function calculateSetInfo(b, a) {
    $.each(b, function (d, f) {
        switch (d) {
            case"name":
            case"phone":
            case"email":
            case"room_count":
            case"bathroom_count":
            case"street":
            case"house":
            case"stage":
            case"flat":
                $('#calculator-pop-up input[name="' + d.replace("_", "-") + '"]').val(f).trigger("change");
                break;
            case"comment":
                $('#calculator-pop-up textarea[name="comment"]').val(f);
                break;
            case"city":
                calculateResult.city = f;
                try {
                    citySelect.val(f).selectmenu("refresh")
                } catch (g) {
                    console.error(g);
                    citySelect.val(f).trigger("change")
                }
                break;
            case"object_type_index":
                $('#calculator-pop-up .calculate-switch .item[data-object_type_index="' + b.object_type_index + '"]').trigger("click");
                break;
            case"cleaning_type":
                $('#calculator-pop-up .middle-content .tab[data-name="' + f + '"]').trigger("click");
                break;
            case"additional_services":
            case"drycleaning":
                $.each(f, function (h, e) {
                    $('#calculator-pop-up .calculate-input.with-controllers input[data-id="' + h + '"]').val(e.count).trigger("change")
                });
                if (d == "drycleaning" && Object.keys(f).length > 0) {
                    $('#calculator-pop-up input[name="need-drycleaning"]').prop("checked", true).trigger("change")
                }
                break;
            case"additional_services_check":
                $.each(f, function (h, e) {
                    $('#calculator-pop-up .additional_services_checkbox input[data-id="' + h + '"]').prop("checked", true).trigger("change")
                });
                break;
            case"payment_type":
                $('#calculator-pop-up input[name="payment"][value="' + f + '"]').trigger("click");
                break;
            case"date":
                dateInput.datepicker("setDate", new Date(f));
                break;
            case"time":
                calculateResult.time = f;
                try {
                    timeSelect.val(f).selectmenu("refresh")
                } catch (g) {
                    console.error(g);
                    timeSelect.val(f).trigger("change")
                }
                break;
            case"stock":
                var c = $('#calculator-pop-up .custom-range-labels.top li[data-percent="' + f + '"]').index() + 1;
                $(".custom-range input").val(c).trigger("input");
                break
        }
    });
    calculateUpdateResult();
    if (a) {
        $("#calculate-total-amount span").html(b.total_amount)
    }
}

function calculateLock() {
    $("#calculator-pop-up .calculate-input").addClass("calculate-input-disabled");
    $("#calculator-pop-up input, #calculator-pop-up textarea, #calculator-pop-up select").attr("disabled", "disabled");
    $("#calculator-pop-up .ui-selectmenu-button.ui-button").addClass("ui-selectmenu-button-disabled");
    $("#calculator-pop-up .custom-range-body").addClass("custom-range-body-disabled");
    $("#calculator-pop-up .middle-content .tab").addClass("tab-disabled");
    $("#calculator-pop-up .top-content .calculate-switch").addClass("calculate-switch-disabled");
    $("#calculator-pop-up .result-order .btn-default, #calculator-pop-up .user-templates").hide()
}

function calculateUnlock() {
    $("#calculator-pop-up .calculate-input").removeClass("calculate-input-disabled");
    $("#calculator-pop-up input, #calculator-pop-up textarea, #calculator-pop-up select").removeAttr("disabled");
    $("#calculator-pop-up .ui-selectmenu-button.ui-button").removeClass("ui-selectmenu-button-disabled");
    $("#calculator-pop-up .custom-range-body").removeClass("custom-range-body-disabled");
    $("#calculator-pop-up .middle-content .tab").removeClass("tab-disabled");
    $("#calculator-pop-up .top-content .calculate-switch").removeClass("calculate-switch-disabled");
    $("#calculator-pop-up .result-order .btn-default, #calculator-pop-up .user-templates").show();
    try {
        citySelect.selectmenu("refresh");
        templateSelect.selectmenu("refresh");
        timeSelect.selectmenu("refresh")
    } catch (a) {
        console.error(a)
    }
}

function calculateSetDefaultData() {
    if (!!calculateDefaultData.name) {
        $('#calculator-pop-up input[name="name"]').val(calculateDefaultData.name)
    }
    if (!!calculateDefaultData.phone) {
        $('#calculator-pop-up input[name="phone"]').val(calculateDefaultData.phone)
    }
    if (!!calculateDefaultData.email) {
        $('#calculator-pop-up input[name="email"]').val(calculateDefaultData.email)
    }
}

calculateSetDefaultData();

function calculateReset() {
    $("#calculator-pop-up .calculate-input.with-controllers input").val(0).trigger("change");
    $('#calculator-pop-up .calculate-input:not(.with-controllers) input[type="text"], #calculator-pop-up textarea').val("").trigger("change");
    dateInput.datepicker("setDate", new Date());
    if (window.outerWidth > 768) {
        $('#calculator-pop-up select[id^="ui-id-"]').each(function (c, a) {
            a = $(a);
            var b = a.find("option").eq(0).val();
            calculateResult[a.attr("name")] = b;
            a.val(b).selectmenu("refresh")
        })
    } else {
        $("#calculator-pop-up select").each(function (c, a) {
            var b;
            a = $(a);
            b = a.find("option").filter('[selected="selected"]');
            if (b.length < 1) {
                b = a.find("option").eq(0);
                console.log("Не нашел дефолтного для ", a)
            }
            calculateResult[a.attr("name")] = b.val();
            a.val(b.val()).trigger("change")
        })
    }
    $("#calculator-pop-up .custom-checkbox input").prop("checked", false).trigger("change");
    if (calculateResult.object_type_index === "house") {
        $("#calculator-pop-up .calculate-switch .item").eq(0).trigger("click")
    }
    $("#calculator-pop-up .middle-content .tab").eq(0).trigger("click");
    $(".custom-range input").val(1).trigger("input");
    $("#calculator-pop-up .custom-radio input").eq(0).trigger("click");
    calculateSetDefaultData();
    calculateUpdateResult()
}

function calculateSetTemplate() {
    var a = templateSelect.find('option[value="' + templateSelect.val() + '"]');
    $('#calculator-pop-up input[name="street"]').val(a.data("street"));
    $('#calculator-pop-up input[name="house"]').val(a.data("house"));
    $('#calculator-pop-up input[name="flat"]').val(a.data("flat"));
    $('#calculator-pop-up input[name="stage"]').val(a.data("stage"));
    try {
        citySelect.val(a.data("city")).selectmenu("refresh")
    } catch (b) {
        console.error(b);
        citySelect.val(a.data("city")).trigger("change")
    }
}

function calculateSetCoupon() {
    var a = couponSelect.find('option[value="' + couponSelect.val() + '"]');
    calculateResult.coupon = couponSelect.val();
    calculateResult.coupon_amount = parseInt(a.data("amount"));
    calculateUpdateResult()
}

function calculateUseCoupon(b) {
    $("#calculator-pop-up .coupons-block select").val(b).trigger("change");
    try {
        couponSelect.selectmenu("refresh")
    } catch (a) {
        console.error(a)
    }
    calculatePopupShow()
}

$(document).mousedown(function (a) {
    var b = $("#calculator-pop-up .window");
    if (!b.is(a.target) && b.has(a.target).length === 0) {
        calculatePopupHide()
    }
});
$(document).keyup(function (a) {
    if (a.keyCode === 27) {
        calculatePopupHide()
    }
});
